<?php
namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use IlluminateSupportFacadesLog;
use App\Models\Accounts;
use zcrmsdk\crm\crud\ZCRMModule;
use zcrmsdk\crm\setup\org\ZCRMOrganization;
use zcrmsdk\crm\setup\restclient\ZCRMRestClient;
use zcrmsdk\crm\setup\users\ZCRMProfile;
use zcrmsdk\crm\setup\users\ZCRMRole;
use zcrmsdk\crm\setup\users\ZCRMUser;
use zcrmsdk\crm\crud\ZCRMOrgTax;
use zcrmsdk\oauth\ZohoOAuth;
use League\CLImate\CLImate;
use Spatie\Tags\Tag;
use \Mailjet\Resources;
use Mailjet\LaravelMailjet\Facades\Mailjet;

class ZohoDelete extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature   = 'zoho:delete';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Delete spam leads in ZohoCRM';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle() {
        $start = microtime(true);
        $configuration = array(
            'client_id' => '1000.8XYKIJOSBT6L90523EUFF2APBJVD4H',
            'client_secret' => '4e89274db40d38a1980aad256620d8bf3849993635',
            'redirect_uri' => 'https://cartessaaesthetics.com/oauthcallback',
            'applicationLogFilePath' => storage_path('zoho'),
            'token_persistence_path' => storage_path('zoho/tokens'),
            'sandbox' => true,
            'currentUserEmail' => 'brandon@southerntidemedia.com',
        );
//        $zohoAuthToken = '1000.73724133e5c049b47466256141023b1c.8f78018effeecff2ef1412f069c4acf2';
        $zohoClient     = ZCRMRestClient::initialize($configuration);
        $oAuthClient = ZohoOAuth::getClientInstance();
        $refreshToken = "1000.822dbb644d515127cc9fcef8b6930685.b0bcd0945e51aa680a71642380d08a73";
        $userIdentifier = "brandon@southerntidemedia.com";
        $oAuthTokens = $oAuthClient->generateAccessTokenFromRefreshToken($refreshToken,$userIdentifier);
        $moreRecords = true;
        $page = 1;
        $updates = $skipped = $new = 0;
        $climate = new \League\CLImate\CLImate;
        $climate->lightGreen()->out('Deleting bad leads with ZohoCRM API.....');
        $climate->lightGreen()->border('*', 40);
        $module = ZCRMModule::getInstance("Leads");
        $param_map=array("page"=>1,"per_page"=>1); // key-value pair containing all the parameters
        $recordids = [];
        $recordids = array('3605471000033642176','3605471000033642177', '3605471000031888274', '3605471000031375110', '3605471000031388115', '3605471000032231336', '3605471000030767139', '3605471000033064442', '3605471000033067429', '3605471000033292110', '3605471000031746138', '3605471000031754061', '3605471000033066405', '3605471000033076220', '3605471000033276215', '3605471000033309107', '3605471000032086943', '3605471000032117961', '3605471000031792059', '3605471000031792060', '3605471000032768207', '3605471000032777414', '3605471000033584061', '3605471000033594051', '3605471000033405135', '3605471000033420162', '3605471000032803007', '3605471000032806015', '3605471000033607196', '3605471000033637135', '3605471000033060298', '3605471000033076152', '3605471000033618001', '3605471000032203306', '3605471000032232340', '3605471000033568068', '3605471000033588037', '3605471000033625224', '3605471000033625225', '3605471000032579216', '3605471000032607269', '3605471000033639239', '3605471000033642231', '3605471000033409043', '3605471000033425056', '3605471000033426076', '3605471000033437122', '3605471000033580088', '3605471000033589064', '3605471000031992122', '3605471000032080002', '3605471000032768086', '3605471000032777352', '3605471000032876007', '3605471000032894001', '3605471000032580086', '3605471000032584128', '3605471000031581234', '3605471000031586131', '3605471000033713133', '3605471000033718040', '3605471000032115681', '3605471000032115682', '3605471000033622001', '3605471000033623001', '3605471000032104958', '3605471000032131991', '3605471000031671090', '3605471000031746001', '3605471000032155055', '3605471000032190050', '3605471000031852061', '3605471000031860064', '3605471000032230165', '3605471000032231218', '3605471000033298087', '3605471000033308124', '3605471000033618135', '3605471000033640263', '3605471000033623068', '3605471000033625049', '3605471000033372119', '3605471000033374102', '3605471000032803073', '3605471000032805169', '3605471000031665001', '3605471000032189147', '3605471000032194030', '3605471000031888090', '3605471000031921045', '3605471000032221479', '3605471000032236331', '3605471000032584266', '3605471000032616379', '3605471000031746259', '3605471000031754170', '3605471000033618046', '3605471000033622014', '3605471000032230214', '3605471000032231252', '3605471000032001069', '3605471000032010063', '3605471000033262135', '3605471000033310301', '3605471000032203281', '3605471000032235305', '3605471000031562110', '3605471000033622083', '3605471000033625149', '3605471000033306072', '3605471000033310186', '3605471000031755117', '3605471000031758134', '3605471000032792086', '3605471000032810056', '3605471000032012021', '3605471000032046048', '3605471000033606172', '3605471000033638084', '3605471000033380073', '3605471000033380074', '3605471000033067257', '3605471000033067258', '3605471000031546049', '3605471000031586047', '3605471000032802160', '3605471000032849116', '3605471000033276144', '3605471000033299090', '3605471000033584019', '3605471000033594023', '3605471000031755066', '3605471000031801101', '3605471000033565018', '3605471000033593029', '3605471000033309199', '3605471000033372004', '3605471000033618250', '3605471000033639279', '3605471000033586027', '3605471000033593001', '3605471000033068475', '3605471000033069731', '3605471000031924103', '3605471000031938104', '3605471000031885106', '3605471000031888141', '3605471000031774166', '3605471000031791141', '3605471000033069439', '3605471000033076049', '3605471000033374077', '3605471000033387087', '3605471000033637018', '3605471000033642072', '3605471000033613058', '3605471000033638013', '3605471000031924092', '3605471000031941151', '3605471000032876102', '3605471000032907029', '3605471000031746092', '3605471000033377018', '3605471000033388055', '3605471000032128143', '3605471000032129032', '3605471000031603032', '3605471000032233177', '3605471000032233178', '3605471000033680015', '3605471000033694008', '3605471000033409132', '3605471000033425136', '3605471000032803036', '3605471000032810011', '3605471000031489042', '3605471000031508001', '3605471000032768059', '3605471000032792039', '3605471000032203204', '3605471000032229311', '3605471000033578018', '3605471000033583001', '3605471000033420002', '3605471000033425001', '3605471000031580037', '3605471000031581014', '3605471000033641159', '3605471000032122605', '3605471000032153617', '3605471000032221453', '3605471000032224224', '3605471000032152132', '3605471000032194008', '3605471000032578313', '3605471000032600310', '3605471000031163095', '3605471000032882058', '3605471000033719113', '3605471000033719114', '3605471000031549055', '3605471000031591046', '3605471000032232351', '3605471000033578007', '3605471000033580001', '3605471000033408225', '3605471000033412083', '3605471000033384042', '3605471000033385114', '3605471000031886326', '3605471000031924251', '3605471000032848212', '3605471000032854182', '3605471000031753123', '3605471000031754082', '3605471000033717277', '3605471000033719190', '3605471000032779057', '3605471000032805106', '3605471000031774094', '3605471000031790254', '3605471000031505030', '3605471000031509012', '3605471000031578099', '3605471000031586198', '3605471000031791093', '3605471000031938037', '3605471000031941110', '3605471000032205234', '3605471000031586022', '3605471000031753195', '3605471000031754116', '3605471000033623053', '3605471000033639150', '3605471000033406115', '3605471000033427024', '3605471000031758165', '3605471000031801164', '3605471000031758112', '3605471000031792110', '3605471000033638035', '3605471000033642109', '3605471000033640285', '3605471000033308210', '3605471000033308211', '3605471000033050732', '3605471000033072237', '3605471000031791119', '3605471000031795149', '3605471000032220005', '3605471000032225001', '3605471000032224274', '3605471000032235355', '3605471000033703060', '3605471000033705024', '3605471000032581123', '3605471000032608231', '3605471000033584045', '3605471000033593066', '3605471000033607033', '3605471000033625017', '3605471000032604124', '3605471000032651168', '3605471000031581302', '3605471000031609119', '3605471000032222221', '3605471000032236179', '3605471000031792142', '3605471000031796155', '3605471000031921111', '3605471000031922117', '3605471000033640132', '3605471000033642134', '3605471000033581009', '3605471000033596059', '3605471000032221580', '3605471000032234354', '3605471000032910087', '3605471000032913009', '3605471000031758091', '3605471000031860018', '3605471000033059181', '3605471000033072259', '3605471000033580034', '3605471000033596001', '3605471000033525033', '3605471000033530150', '3605471000032207490', '3605471000032236345', '3605471000033277163', '3605471000033282155', '3605471000032232425', '3605471000032237242', '3605471000033424120', '3605471000032984124', '3605471000031911103', '3605471000032512055', '3605471000032551142', '3605471000031591276', '3605471000031603075', '3605471000032487047', '3605471000032514017', '3605471000032128116', '3605471000032131094', '3605471000033286243', '3605471000033299139', '3605471000033380125', '3605471000033386068', '3605471000032579122', '3605471000032580183', '3605471000033382137', '3605471000033387122', '3605471000033377063', '3605471000033380036', '3605471000032023115', '3605471000032046022', '3605471000031921082', '3605471000033638128', '3605471000033640353', '3605471000032584212', '3605471000032607078', '3605471000032603051', '3605471000032616041', '3605471000033705086', '3605471000033726057', '3605471000033049391', '3605471000033050646', '3605471000033371030', '3605471000032881074', '3605471000032918068', '3605471000033713375', '3605471000033716402', '3605471000033531030', '3605471000033542010', '3605471000033372147', '3605471000033382112', '3605471000033420306', '3605471000033423075', '3605471000033376170', '3605471000033386091', '3605471000033716194', '3605471000033282177', '3605471000031886254', '3605471000031924175', '3605471000033612137', '3605471000033640315', '3605471000031764211', '3605471000032234208', '3605471000031885060', '3605471000031941121', '3605471000031885134', '3605471000031924137', '3605471000033616007', '3605471000033618013', '3605471000033262096', '3605471000033308169', '3605471000032582287', '3605471000032607152', '3605471000033282249', '3605471000033308283', '3605471000032484025', '3605471000032499039', '3605471000033256071', '3605471000033286214', '3605471000031918054', '3605471000031918055', '3605471000033608111', '3605471000033637053', '3605471000033568013', '3605471000033594012', '3605471000033694156', '3605471000033712098', '3605471000031886284', '3605471000031927173', '3605471000033276119', '3605471000033307087', '3605471000031888220', '3605471000031899058', '3605471000032805013', '3605471000032848001', '3605471000032221385', '3605471000032224157', '3605471000033381084', '3605471000033386137', '3605471000031791048', '3605471000031852037', '3605471000032880011', '3605471000032909104', '3605471000032229470', '3605471000032236485', '3605471000032521031', '3605471000032551032', '3605471000032232315', '3605471000032235330', '3605471000031885174', '3605471000031885175', '3605471000032699114', '3605471000032716058', '3605471000033703119', '3605471000033713327', '3605471000032104030', '3605471000032117018', '3605471000032499009', '3605471000032513002', '3605471000033409070', '3605471000033436146', '3605471000033639188', '3605471000033642156', '3605471000031911125', '3605471000031928059', '3605471000032779095', '3605471000033612040', '3605471000033619027', '3605471000031754147', '3605471000033412165', '3605471000033437148', '3605471000033408307', '3605471000033437106', '3605471000032581037', '3605471000032080030', '3605471000033586002', '3605471000033589002', '3605471000031774117', '3605471000031791064', '3605471000032894023', '3605471000032894024', '3605471000033379066', '3605471000032768145', '3605471000032854102', '3605471000033622061', '3605471000033640194', '3605471000031557038', '3605471000031557039', '3605471000033612029', '3605471000033640121', '3605471000033425118', '3605471000033436131', '3605471000031577013', '3605471000031591011', '3605471000033372030', '3605471000033382024', '3605471000031792200', '3605471000031916001', '3605471000031746281', '3605471000031796222', '3605471000031918151', '3605471000031918152', '3605471000032619204', '3605471000032651143', '3605471000033623122', '3605471000033640207', '3605471000033306001', '3605471000033307001', '3605471000032779025', '3605471000032806057', '3605471000032770091', '3605471000032847080', '3605471000032104983', '3605471000032190023', '3605471000032231189', '3605471000032232232', '3605471000032152158', '3605471000032153666', '3605471000032604205', '3605471000032616355', '3605471000033385054', '3605471000033385055', '3605471000031375137', '3605471000031377088', '3605471000032124165', '3605471000032131056', '3605471000033277179', '3605471000033299170', '3605471000032003022', '3605471000032010006', '3605471000033577002', '3605471000033583023', '3605471000031852116', '3605471000031860092', '3605471000031753027', '3605471000031789073', '3605471000031579097', '3605471000031579098', '3605471000033607072', '3605471000033641011', '3605471000031482012', '3605471000031485027', '3605471000033375155', '3605471000033378113', '3605471000031579011', '3605471000031581057', '3605471000031580088', '3605471000031609085', '3605471000033376133', '3605471000033386040', '3605471000033567063', '3605471000033568038', '3605471000032224526', '3605471000032235545', '3605471000031552067', '3605471000031577065', '3605471000031486023', '3605471000031508024', '3605471000032229247', '3605471000032232208', '3605471000031784072', '3605471000031852084', '3605471000031916218', '3605471000031920138', '3605471000032608179', '3605471000032608180', '3605471000033613083', '3605471000033625134', '3605471000033378014', '3605471000033378015', '3605471000031554110', '3605471000031578050', '3605471000032768233', '3605471000032779111', '3605471000032805248', '3605471000033616136', '3605471000033622162', '3605471000032848109', '3605471000031746333', '3605471000031860190', '3605471000031888155', '3605471000033531007', '3605471000033538001', '3605471000033608072', '3605471000033640143', '3605471000032579033', '3605471000032597040', '3605471000033623097', '3605471000033637075', '3605471000031758042', '3605471000031774042', '3605471000031911049', '3605471000031918122', '3605471000031581280', '3605471000031603137', '3605471000033064116', '3605471000033076184', '3605471000032224386', '3605471000032225701', '3605471000032848184', '3605471000031927039', '3605471000031928028', '3605471000032770027', '3605471000032805147', '3605471000033701134', '3605471000033731080', '3605471000032578129', '3605471000032608057', '3605471000032609096', '3605471000031889012', '3605471000031557130', '3605471000031581268', '3605471000032220476', '3605471000032224504', '3605471000031764169', '3605471000031801131', '3605471000033425160', '3605471000033437177', '3605471000032078074', '3605471000031746163', '3605471000033587021', '3605471000033593054', '3605471000032511105', '3605471000032551116', '3605471000033625063', '3605471000033640169', '3605471000032236210', '3605471000032237112', '3605471000032129591', '3605471000032149635', '3605471000033408026', '3605471000033413017', '3605471000032600283', '3605471000032616333', '3605471000032203494', '3605471000032222489', '3605471000033725055', '3605471000033731152', '3605471000033383038', '3605471000033385028', '3605471000033292064', '3605471000033298065', '3605471000033383111', '3605471000033385136', '3605471000033387018', '3605471000033387019', '3605471000033701035', '3605471000033717054', '3605471000033376005', '3605471000033382001', '3605471000031753172', '3605471000031796133', '3605471000033532010', '3605471000033540044', '3605471000032513086', '3605471000032513087', '3605471000033639118', '3605471000033640082', '3605471000031996148', '3605471000032020016', '3605471000033424151', '3605471000033426098', '3605471000033409103', '3605471000033412127', '3605471000032947106', '3605471000032990072', '3605471000033595062', '3605471000033064189', '3605471000033068353', '3605471000031784061', '3605471000031789182', '3605471000033282054', '3605471000033307112', '3605471000032222353', '3605471000032233379', '3605471000032521068', '3605471000032527049', '3605471000033306103', '3605471000033308147', '3605471000033374015', '3605471000033383006', '3605471000032232383', '3605471000032115658', '3605471000032129503', '3605471000032119065', '3605471000032128055', '3605471000031553051', '3605471000031562136', '3605471000031664144', '3605471000031673021', '3605471000033410179', '3605471000033423139', '3605471000033619155', '3605471000033638106', '3605471000032607056', '3605471000031580116', '3605471000031603115', '3605471000033206009', '3605471000032224408', '3605471000032236426', '3605471000033420339', '3605471000033435104', '3605471000032203472', '3605471000032207702', '3605471000032118008', '3605471000032131028', '3605471000032221341', '3605471000032231146', '3605471000032580209', '3605471000032609222', '3605471000031755042', '3605471000033578029', '3605471000033580069', '3605471000032225633', '3605471000032230266', '3605471000032078624', '3605471000032151424', '3605471000033048263', '3605471000033075461', '3605471000031546024', '3605471000031549044', '3605471000033405001', '3605471000033406001', '3605471000032579144', '3605471000032603142', '3605471000033589027', '3605471000032224208', '3605471000033596023', '3605471000033701262', '3605471000032528085', '3605471000032086914', '3605471000033641036', '3605471000032806004', '3605471000033308098', '3605471000033701067', '3605471000033716195', '3605471000033286168', '3605471000031938026', '3605471000032600207', '3605471000032234266', '3605471000032929009', '3605471000032237205');
        $total = count($recordids);
        for ($i=0; $i < $total; $i++) {
            echo 'Deleteng rack '  . $i .  PHP_EOL;
            $deleted = $module->deleteRecords([$recordids[$i]]);
            foreach ($deleted->getEntityResponses() as $responseIns) {
                $this->info("HTTP Status Code:" . $deleted->getHttpStatusCode());
                $this->info("Status:" . $responseIns->getStatus()); // To get response status
                $this->info("Message:" . $responseIns->getMessage()); // To get response message
                $this->info("Code:" . $responseIns->getCode()); // To get status code
                $this->info("Details:" . json_encode($responseIns->getDetails()));
            }
        }
/*
        $padding = $climate->padding(10);
        $padding->label('Created')->result($new);
        $padding->label('Updated')->result($updates);
        $padding->label('Skipped')->result($skipped);

        $time_elapsed_secs = microtime(true) - $start;
        $padding->label('Time Completed in')->result($time_elapsed_secs);
/*
        $subject = 'ZohoSync completed at Cartessa';
        $message = "
        <h2>Syncing data complete</h2><p>
        Created {$new}<br>
        Updated {$updates}<br>
        Skipped {$skipped}<br></p>
        <p>Completed in {$time_elapsed_secs} seconds</p>";
        $headers = 'From: maps@cartessa.com' . "\r\n" .
                   'Reply-To: ithippyshawn@gmail.com' . "\r\n" .
                   'X-Mailer: PHP/' . phpversion();
        mail('ithippyshawn@gmail.com', $subject, $message, $headers);
        // use the below scope
        //ZohoCRM.modules.ALL,ZohoCRM.settings.ALL,aaaserver.profile.READ,ZohoCRM.org.all,ZohoCRM.users.all,ZohoCRM.bulk.all,ZohoCRM.modules.accounts.all

        $mj = new \Mailjet\Client(getenv('MAILJET_APIKEY'), getenv('MAILJET_APISECRET'),true,['version' => 'v3.1']);
        $body = [
            'Messages' => [
                [
                    'From' => [
                        'Email' => "ithippyshawn@gmail.com",
                        'Name' => "ZohoCRM CRON Report"
                    ],
                    'To' => [
                        [
                            'Email' => "ithippyshawn@gmail.com",
                            'Name' => "Shawn Crigger"
                        ]
                    ],
                    'Subject' => $subject,
                    'TextPart' => strip_tags($message),
                    'HTMLPart' => $message,
                ]
            ]
        ];
        $response = $mj->post(Resources::$Email, ['body' => $body]);
        $response->success() && var_dump($response->getData());
/*
        $mailjet = Mailjet::getClient();
        // Resources are all located in the Resources class
        $response = $mailjet->get(Resources::$Contact);

        if ($response->success()) {
            var_dump($response->getData());
        } else {
            var_dump($response->getStatus());
        }
        $body = array(
            'FromEmail' => "ithippyshawn@gmail.com",
            'FromName' => "ZohoCRM CRON Report",
            'Subject' => $subject,
            'Text-part' => strip_tags($message),
            'Html-part' => $message,
            'Recipients' => [['Email' => "ithippyshawn@gmail.com"]]
        );
        $response = $mailjet->post(Resources::$Email, ['body' => $body]);
*/
    }

}
